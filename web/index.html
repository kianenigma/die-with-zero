<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Die With Zero - Financial Planner</title>
	<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
	<style>
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		:root {
			--bg-primary: #ffffff;
			--bg-secondary: #fafafa;
			--bg-tertiary: #f5f5f5;
			--text-primary: #2c3e50;
			--text-secondary: #555;
			--border-color: #e0e0e0;
			--input-bg: #ffffff;
			--input-border: #ddd;
			--table-header-bg: #34495e;
			--table-header-text: #ffffff;
			--table-hover: #f8f9fa;
			--asset-group-bg: #ffffff;
			--key-metrics-bg: #ecf0f1;
			--button-bg: #3498db;
			--button-hover: #2980b9;
		}

		body.dark-theme {
			--bg-primary: #1e1e1e;
			--bg-secondary: #252525;
			--bg-tertiary: #2d2d2d;
			--text-primary: #e0e0e0;
			--text-secondary: #b0b0b0;
			--border-color: #404040;
			--input-bg: #2d2d2d;
			--input-border: #404040;
			--table-header-bg: #2d2d2d;
			--table-header-text: #e0e0e0;
			--table-hover: #333333;
			--asset-group-bg: #2d2d2d;
			--key-metrics-bg: #2d2d2d;
			--button-bg: #3498db;
			--button-hover: #2980b9;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: var(--bg-tertiary);
			padding: 0;
			margin: 0;
			line-height: 1.4;
			font-size: 14px;
			color: var(--text-primary);
			transition: background-color 0.3s, color 0.3s;
		}

		.container {
			display: flex;
			height: 100vh;
			background: var(--bg-primary);
		}

		.sidebar {
			flex: 0 0 33.333%;
			padding: 20px;
			overflow-y: auto;
			border-right: 2px solid var(--border-color);
			background: var(--bg-secondary);
			position: relative;
			z-index: 100;
			transition: flex 0.3s, padding 0.3s, opacity 0.3s;
		}

		.sidebar.collapsed {
			flex: 0 0 0;
			padding: 0;
			overflow: hidden;
			opacity: 0;
			border-right: none;
		}

		.main-content {
			flex: 1;
			padding: 20px;
			overflow-y: auto;
			position: relative;
			z-index: 1;
		}

		.controls-bar {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			align-items: center;
		}

		.toggle-btn {
			background: var(--button-bg);
			color: white;
			padding: 8px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.85em;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.toggle-btn:hover {
			background: var(--button-hover);
		}

		h1 {
			color: var(--text-primary);
			margin-bottom: 15px;
			font-size: 1.5em;
		}

		h2 {
			color: var(--text-primary);
			margin: 20px 0 10px 0;
			font-size: 1.1em;
			border-bottom: 1px solid #3498db;
			padding-bottom: 5px;
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 10px;
			margin-bottom: 15px;
		}

		.form-grid.single-column {
			grid-template-columns: 1fr;
		}

		.form-grid.three-column {
			grid-template-columns: 1fr 1fr 1fr;
		}

		.form-group {
			display: flex;
			flex-direction: column;
		}

		label {
			font-weight: 600;
			margin-bottom: 3px;
			color: var(--text-secondary);
			font-size: 0.85em;
		}

		input, select {
			padding: 6px 8px;
			border: 1px solid var(--input-border);
			border-radius: 4px;
			font-size: 0.9em;
			min-width: 0;
			width: 100%;
			background: var(--input-bg);
			color: var(--text-primary);
		}

		input:focus, select:focus {
			outline: none;
			border-color: #3498db;
		}

		.asset-group {
			border: 1px solid var(--border-color);
			padding: 8px;
			border-radius: 4px;
			margin-bottom: 8px;
			background: var(--asset-group-bg);
		}

		.asset-grid {
			display: grid;
			grid-template-columns: minmax(0, 2fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) auto;
			gap: 6px;
			align-items: end;
		}

		.asset-grid .form-group {
			min-width: 0;
		}

		.asset-grid button.remove {
			margin-top: 0;
		}

		button {
			background: #3498db;
			color: white;
			padding: 6px 12px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.85em;
			margin-top: 5px;
		}

		button:hover {
			background: #2980b9;
		}

		button.remove {
			background: #e74c3c;
			padding: 6px 10px;
		}

		button.remove:hover {
			background: #c0392b;
		}

		.chart-container {
			position: relative;
			height: 400px;
			margin: 20px 0;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin: 10px 0;
			font-size: 0.8em;
		}

		th, td {
			padding: 6px 8px;
			text-align: right;
			border-bottom: 1px solid var(--border-color);
		}

		th {
			background: var(--table-header-bg);
			color: var(--table-header-text);
			font-weight: 600;
			position: sticky;
			top: 0;
		}

		td {
			color: var(--text-primary);
		}

		tr:hover {
			background: var(--table-hover);
		}

		.asset-changes {
			display: block;
			font-size: 0.75em;
			margin-top: 2px;
			white-space: nowrap;
		}

		.appreciation {
			color: #27ae60;
			margin-right: 8px;
		}

		.contribution {
			color: #52c41a;
			margin-right: 8px;
		}

		.loss {
			color: #e74c3c;
		}

		.positive-savings {
			color: #27ae60;
		}

		.negative-savings {
			color: #e74c3c;
		}

		.table-container {
			margin: 20px 0;
		}

		.milestone-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 6px;
			margin-bottom: 10px;
		}

		.milestone-input {
			display: flex;
			gap: 6px;
			align-items: center;
		}

		.milestone-input input {
			flex: 1;
		}

		.key-metrics {
			background: var(--key-metrics-bg);
			padding: 12px;
			border-radius: 4px;
			margin: 15px 0;
		}

		.key-metrics p {
			margin: 6px 0;
			font-size: 0.9em;
			color: var(--text-primary);
		}

		.key-metrics strong {
			color: var(--text-primary);
		}

		.inline-input {
			display: inline-block;
			width: 100px;
			padding: 2px 6px;
			border: 1px solid var(--input-border);
			border-radius: 3px;
			font-size: 1em;
			background: var(--input-bg);
			color: var(--text-primary);
			text-align: right;
		}

		.inline-input:focus {
			outline: none;
			border-color: #3498db;
		}

		.label-with-tooltip {
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.tooltip-icon {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 12px;
			height: 12px;
			border-radius: 50%;
			background: #95a5a6;
			color: white;
			font-size: 8px;
			font-weight: normal;
			cursor: help;
			opacity: 0.6;
		}

		.tooltip-icon:hover {
			opacity: 1;
		}

		.tooltip-popup {
			position: fixed;
			background: #2c3e50;
			color: white;
			padding: 8px 12px;
			border-radius: 4px;
			font-size: 12px;
			font-weight: normal;
			white-space: normal;
			z-index: 999999;
			max-width: 350px;
			width: max-content;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			pointer-events: none;
			display: none;
		}

		.tooltip-popup::before {
			content: '';
			position: absolute;
			border: 6px solid transparent;
			border-right-color: #2c3e50;
			left: -12px;
			top: 50%;
			transform: translateY(-50%);
		}
	</style>
</head>
<body>
	<div class="tooltip-popup" id="tooltip"></div>
	<div id="app">
		<div class="container">
			<!-- Sidebar with Parameters -->
			<div class="sidebar" :class="{ collapsed: sidebarCollapsed }">
				<h1>Die With Zero - Financial Planner</h1>

				<!-- Save/Load Controls -->
				<div class="controls-bar" style="margin-bottom: 20px;">
					<button class="toggle-btn" @click="saveParameters">
						💾 Save Parameters
					</button>
					<button class="toggle-btn" @click="$refs.fileInput.click()">
						📂 Load Parameters
					</button>
					<input type="file" ref="fileInput" @change="loadParameters" accept=".json" style="display: none;">
				</div>

				<!-- Basic Parameters -->
			<h2>Basic Parameters</h2>
			<div class="form-grid">
				<div class="form-group">
					<div class="label-with-tooltip">
						<label>Annual Gross Income ({{ params.currency }})</label>
						<span class="tooltip-icon" :data-tooltip="tooltips.annualGrossIncome">?</span>
					</div>
					<input type="text"
						:value="formatInputNumber(params.annualGrossIncome)"
						@input="params.annualGrossIncome = parseInputNumber($event.target.value)">
				</div>
				<div class="form-group">
					<div class="label-with-tooltip">
						<label>Annual Base Expenses ({{ params.currency }})</label>
						<span class="tooltip-icon" :data-tooltip="tooltips.annualExpenses">?</span>
					</div>
					<input type="text"
						:value="formatInputNumber(params.annualExpenses)"
						@input="params.annualExpenses = parseInputNumber($event.target.value)">
				</div>
			</div>
			<div class="form-grid">
				<div class="form-group">
					<div class="label-with-tooltip">
						<label>Inflation Rate (%)</label>
						<span class="tooltip-icon" :data-tooltip="tooltips.inflationRate">?</span>
					</div>
					<input type="number" v-model.number="params.inflationRate" step="0.1">
				</div>
				<div class="form-group">
					<div class="label-with-tooltip">
						<label>Income Growth Rate (%)</label>
						<span class="tooltip-icon" :data-tooltip="tooltips.incomeGrowthRate">?</span>
					</div>
					<input type="number" v-model.number="params.incomeGrowthRate" step="0.1">
				</div>
			</div>
			<div class="form-grid">
				<div class="form-group">
					<div class="label-with-tooltip">
						<label>Projection Years</label>
						<span class="tooltip-icon" :data-tooltip="tooltips.projectionYears">?</span>
					</div>
					<input type="number" v-model.number="params.years" min="1" max="100">
				</div>
				<div class="form-group">
					<label>Currency</label>
					<select v-model="params.currency">
						<option value="$">$ (USD)</option>
						<option value="€">€ (EUR)</option>
						<option value="£">£ (GBP)</option>
						<option value="¥">¥ (JPY/CNY)</option>
						<option value="₹">₹ (INR)</option>
						<option value="₿">₿ (BTC)</option>
					</select>
				</div>
			</div>

			<!-- Tax Rates Schedule -->
			<h2>Tax Rate Schedule
				<span class="tooltip-icon" :data-tooltip="tooltips.taxRateSchedule" style="margin-left: 8px;">?</span>
			</h2>
			<div v-for="(taxRate, index) in params.taxRates" :key="index" class="asset-group">
				<div class="asset-grid" style="grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 2fr) auto;">
					<div class="form-group">
						<label>Starting Year</label>
						<input type="number" v-model.number="taxRate.year" min="0">
					</div>
					<div class="form-group">
						<label>Tax Rate (%)</label>
						<input type="number" v-model.number="taxRate.rate" step="0.1" min="0" max="100">
					</div>
					<div class="form-group">
						<label>Est. Net Income</label>
						<input type="text" :value="formatCurrency(getEstimatedIncomeForTaxRate(taxRate))" readonly>
					</div>
					<button class="remove" @click="removeTaxRate(index)" v-if="params.taxRates.length > 1">×</button>
				</div>
			</div>
			<button @click="addTaxRate">+ Add Tax Rate</button>

			<!-- Additional Expenses Schedule -->
			<h2>Additional Expenses Schedule
				<span class="tooltip-icon" :data-tooltip="tooltips.additionalExpenses" style="margin-left: 8px;">?</span>
			</h2>
			<div v-for="(expense, index) in params.additionalExpenses" :key="index" class="asset-group">
				<div class="asset-grid" style="grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 2fr) auto;">
					<div class="form-group">
						<label>Starting Year</label>
						<input type="number" v-model.number="expense.year" min="0">
					</div>
					<div class="form-group">
						<label>Annual Amount (€)</label>
						<input type="text"
							:value="formatInputNumber(expense.amount)"
							@input="expense.amount = parseInputNumber($event.target.value)">
					</div>
					<div class="form-group">
						<label>Description</label>
						<input type="text" v-model="expense.description">
					</div>
					<button class="remove" @click="removeAdditionalExpense(index)" v-if="params.additionalExpenses.length > 1">×</button>
				</div>
			</div>
			<button @click="addAdditionalExpense">+ Add Additional Expense</button>

			<!-- Assets -->
			<h2>Asset Allocation
				<span class="tooltip-icon" :data-tooltip="tooltips.assetAllocation" style="margin-left: 8px;">?</span>
			</h2>
			<div v-for="(asset, index) in params.assets" :key="index" class="asset-group">
				<div class="asset-grid">
					<div class="form-group">
						<label>Asset Name</label>
						<input type="text" v-model="asset.name">
					</div>
					<div class="form-group">
						<label>Amount ({{ params.currency }})</label>
						<input type="text"
							:value="formatInputNumber(asset.amount)"
							@input="asset.amount = parseInputNumber($event.target.value)">
					</div>
					<div class="form-group">
						<div class="label-with-tooltip">
							<label>Return Rate (%)</label>
							<span class="tooltip-icon" :data-tooltip="tooltips.returnRate">?</span>
						</div>
						<input type="number" v-model.number="asset.rate" step="0.1">
					</div>
					<div class="form-group">
						<div class="label-with-tooltip">
							<label>Liquid?</label>
							<span class="tooltip-icon" :data-tooltip="tooltips.liquid">?</span>
						</div>
						<select v-model="asset.liquid">
							<option :value="true">Yes</option>
							<option :value="false">No</option>
						</select>
					</div>
					<button class="remove" @click="removeAsset(index)" v-if="params.assets.length > 1">×</button>
				</div>
			</div>
			<button @click="addAsset">+ Add Asset</button>

			<!-- Milestones -->
			<h2>Milestones
				<span class="tooltip-icon" :data-tooltip="tooltips.milestones" style="margin-left: 8px;">?</span>
			</h2>
			<div class="milestone-grid">
				<div v-for="(milestone, index) in params.milestones" :key="index" class="milestone-input">
					<input type="text"
						:value="formatInputNumber(params.milestones[index])"
						@input="params.milestones[index] = parseInputNumber($event.target.value)"
						placeholder="Milestone amount (€)">
					<button class="remove" @click="removeMilestone(index)">×</button>
				</div>
			</div>
			<button @click="addMilestone">+ Add Milestone</button>
			</div>

			<!-- Main Content with Results -->
			<div class="main-content">
				<div class="controls-bar">
					<button class="toggle-btn" @click="toggleSidebar">
						{{ sidebarCollapsed ? '→ Show' : '← Hide' }} Parameters
					</button>
					<button class="toggle-btn" @click="toggleTheme">
						{{ darkTheme ? '☀️ Light' : '🌙 Dark' }} Theme
					</button>
					<button class="toggle-btn" @click="resetZoom">
						🔍 Reset Zoom
					</button>
				</div>
			<div v-if="projection.length > 0">
				<!-- Key Metrics -->
				<h2>Key Metrics</h2>
				<div class="key-metrics">
					<p><strong>Initial Net Worth:</strong> {{ params.currency }}{{ formatNumber(projection[0].totalNetWorth) }}</p>
					<p><strong>Final Net Worth (Year {{ params.years }}):</strong> {{ params.currency }}{{ formatNumber(projection[projection.length - 1].totalNetWorth) }}</p>
					<p><strong>Total Growth:</strong> {{ params.currency }}{{ formatNumber(projection[projection.length - 1].totalNetWorth - projection[0].totalNetWorth) }}</p>
					<p><strong>Total Return:</strong> {{ (((projection[projection.length - 1].totalNetWorth / projection[0].totalNetWorth) - 1) * 100).toFixed(1) }}%</p>
				</div>

				<!-- Die With Zero Analysis -->
				<h2>
					Die With {{ params.currency }}<input
						type="text"
						class="inline-input"
						:value="formatInputNumber(params.targetFinalNetWorth || 0)"
						@input="updateTargetFinalNetWorth($event.target.value)"
						placeholder="0"> Analysis
					<span class="tooltip-icon" :data-tooltip="tooltips.targetFinalNetWorth" style="margin-left: 8px;">?</span>
				</h2>
				<div class="key-metrics">
					<p><strong>If you stop working NOW (year 0):</strong></p>
					<p style="margin-left: 20px;">Final net worth in year {{ params.years }}: {{ params.currency }}{{ formatNumber(dieWithZero.stopNow) }}</p>
					<p style="margin-top: 15px;"><strong>Optimal retirement year to reach {{ params.currency }}{{ formatNumber(dieWithZero.target) }}:</strong></p>
					<p v-if="dieWithZero.optimalYear > 0" style="margin-left: 20px;">
						Stop working at year {{ dieWithZero.optimalYear }}<br>
						Final net worth in year {{ params.years }}: {{ params.currency }}{{ formatNumber(dieWithZero.optimalFinalWorth) }}
					</p>
					<p v-else style="margin-left: 20px; color: #e74c3c;">
						Cannot reach target - expenses exceed asset growth even with continued income
					</p>
				</div>

				<!-- Chart -->
				<h2>Net Worth Projection</h2>
				<div class="chart-container">
					<canvas ref="chart"></canvas>
				</div>

				<!-- Table -->
				<h2>Yearly Breakdown
					<span class="tooltip-icon" :data-tooltip="tooltips.yearlyBreakdown" style="margin-left: 8px;">?</span>
				</h2>
				<div class="table-container">
					<table>
						<thead>
							<tr>
								<th>Year</th>
								<th>Gross Income</th>
								<th>Net Income</th>
								<th>Base Expenses</th>
								<th>Additional Expenses</th>
								<th>Total Expenses</th>
								<th>Savings</th>
								<th v-for="asset in params.assets" :key="asset.name">{{ asset.name }}</th>
								<th>Total Net Worth</th>
								<th>Milestones</th>
							</tr>
						</thead>
						<tbody>
							<tr v-for="row in projection" :key="row.year">
								<td>{{ row.year }}</td>
								<td>{{ params.currency }}{{ formatNumber(row.grossIncome) }}</td>
								<td>{{ params.currency }}{{ formatNumber(row.netIncome) }}</td>
								<td>{{ params.currency }}{{ formatNumber(row.baseExpenses) }}</td>
								<td>{{ params.currency }}{{ formatNumber(row.additionalExpenses) }}</td>
								<td>{{ params.currency }}{{ formatNumber(row.expenses) }}</td>
								<td :class="row.savings > 0 ? 'positive-savings' : (row.savings < 0 ? 'negative-savings' : '')">{{ params.currency }}{{ formatNumber(Math.abs(row.savings)) }}</td>
								<td v-for="asset in params.assets" :key="asset.name">
									<div>{{ params.currency }}{{ formatNumber(row.assets[asset.name] || 0) }}</div>
									<div v-if="row.year > 0 && (row.assetAppreciation[asset.name] > 0 || row.assetContributions[asset.name] > 0 || row.assetLosses[asset.name] > 0)" class="asset-changes">
										<span v-if="row.assetAppreciation[asset.name] > 0" class="appreciation">↑{{ params.currency }}{{ formatNumber(row.assetAppreciation[asset.name]) }}</span>
										<span v-if="row.assetContributions[asset.name] > 0" class="contribution">↑↑{{ params.currency }}{{ formatNumber(row.assetContributions[asset.name]) }}</span>
										<span v-if="row.assetLosses[asset.name] > 0" class="loss">↓{{ params.currency }}{{ formatNumber(row.assetLosses[asset.name]) }}</span>
									</div>
								</td>
								<td>
									<div><strong>{{ params.currency }}{{ formatNumber(row.totalNetWorth) }}</strong></div>
									<div v-if="row.year > 0 && row.netWorthChange !== 0" class="asset-changes">
										<span :class="row.netWorthChange > 0 ? 'gain' : 'loss'">
											{{ row.netWorthChange > 0 ? '↑' : '↓' }}{{ params.currency }}{{ formatNumber(Math.abs(row.netWorthChange)) }}
										</span>
									</div>
								</td>
								<td>{{ row.unrealizedMilestones }}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			</div>
		</div>
	</div>

	<script>
		// ============================================================================
		// CONFIGURATION - Change these values to customize initial parameters
		// ============================================================================

		// Real data (your actual financial situation)
		const K = 1000;
		const M = 1000 * K;

		// Example data (safe to share with others)
		const EXAMPLE_DATA = {
			currency: '€',
			annualGrossIncome: 80000,
			annualExpenses: 40000,
			years: 40,
			inflationRate: 3,
			incomeGrowthRate: 3,
			taxRates: [
				{ year: 0, rate: 30 },
				{ year: 20, rate: 100 }
			],
			additionalExpenses: [
				{ year: 0, amount: 15000, description: 'Kids education' },
				{ year: 18, amount: 0, description: 'None' }
			],
			assets: [
				{ name: 'ETFs', amount: 200000, rate: 4, liquid: true },
				{ name: 'Crypto', amount: 50000, rate: 6, liquid: true },
				{ name: 'Real Estate', amount: 400000, rate: 1, liquid: false }
			],
			milestones: [500 * K, M],
			targetFinalNetWorth: 0
		};

		// ============================================================================

		// Tooltip descriptions
		const TOOLTIPS = {
			annualGrossIncome: "Your projected annual income while working. Use a pessimistic (lower) estimate to be conservative.",
			annualExpenses: "Your baseline living expenses to maintain a good lifestyle. Use a pessimistic (higher) estimate.",
			projectionYears: "Number of years to project into the future.",
			inflationRate: "Annual inflation rate applied to your base expenses. If 2%, your expenses increase 2% per year.",
			incomeGrowthRate: "Annual income growth rate. If 2%, your salary grows 2% per year. Compare to inflation rate: same = keeping pace with economy, higher = outpacing inflation, lower = falling behind. Note that even if your income growth rate is equal to the inflation rate, a higher, but equal value has a different effect -- your expenses grow faster, and you liquidate assets when not working faster.",
			taxRateSchedule: "Define tax rates that change over time. Applied to gross income. Years must be in ascending order. Higher tax percentages can represent you taking a step back, and having less income. A 100% tax rate means you stop working.",
			additionalExpenses: "Extra expenses beyond base (e.g., kids, parents care). These are added on top of your base expenses. Expenses start at the specified year and continue until the end of the projection. To terminate an expense, add another entry with 0 amount at the desired year.",
			assetAllocation: "Your current assets and their expected returns. Liquid assets can be used to cover expenses, non-liquid cannot.",
			returnRate: "Expected annual return/appreciation rate for this asset.",
			liquid: "Can this asset be sold/liquidated to cover expenses? (Yes for stocks/crypto, No for primary residence)",
			milestones: "Net worth goals to track. The table shows which milestones haven't been reached yet.",
			targetFinalNetWorth: "The target net worth you want to have at the end of the projection period. Set to 0 to 'die with zero', or any amount you want to leave behind or have as a safety buffer.",
			yearlyBreakdown: "Year 0 represents your starting point (no savings or gains yet). From year 1 onwards, each asset column shows the current value with: appreciation (green ↑) from growth rate, contributions (lighter green ↑↑) from your savings (only liquid assets), and losses (red ↓) from liquidation to cover expenses. Total Net Worth shows the net change (green/red ↑/↓) from the previous year."
		};

		const { createApp } = Vue;

		createApp({
			data() {
				return {
					params: EXAMPLE_DATA,
					chartInstance: null,
					tooltips: TOOLTIPS,
					sidebarCollapsed: false,
					darkTheme: true
				};
			},
			computed: {
				projection() {
					return this.calculateProjection();
				},
				dieWithZero() {
					const target = this.params.targetFinalNetWorth || 0;

					// Calculate if you stop working now
					const stopNowProjection = this.calculateProjectionWithZeroIncome(0);
					const stopNow = stopNowProjection[stopNowProjection.length - 1].totalNetWorth;

					// Find optimal retirement year to reach target
					let bestYear = 0;
					let bestDiff = Math.abs(stopNow - target);
					let optimalFinalWorth = stopNow;

					for (let retireYear = 1; retireYear <= this.params.years; retireYear++) {
						const projection = this.calculateProjectionWithZeroIncome(retireYear);
						const finalWorth = projection[projection.length - 1].totalNetWorth;
						const diff = Math.abs(finalWorth - target);

						if (diff < bestDiff) {
							bestDiff = diff;
							bestYear = retireYear;
							optimalFinalWorth = finalWorth;
						}

						// If net worth goes too negative, we've gone too far
						if (finalWorth < target - Math.abs(target)) {
							break;
						}
					}

					return {
						stopNow,
						optimalYear: bestYear,
						optimalFinalWorth,
						target
					};
				}
			},
			watch: {
				params: {
					handler() {
						this.$nextTick(() => {
							this.updateChart();
						});
					},
					deep: true
				}
			},
			methods: {
				toggleSidebar() {
					this.sidebarCollapsed = !this.sidebarCollapsed;
					// Wait for transition to complete before updating chart
					setTimeout(() => {
						this.updateChart();
					}, 300);
				},
				toggleTheme() {
					this.darkTheme = !this.darkTheme;
					document.body.classList.toggle('dark-theme', this.darkTheme);
					// Update chart to match new theme
					this.$nextTick(() => {
						this.updateChart();
					});
				},
				resetZoom() {
					if (this.chartInstance) {
						this.chartInstance.resetZoom();
					}
				},
				updateTargetFinalNetWorth(value) {
					this.params.targetFinalNetWorth = this.parseInputNumber(value);
				},
				saveParameters() {
					// Create a JSON string of the current parameters
					const dataStr = JSON.stringify(this.params, null, 2);
					const dataBlob = new Blob([dataStr], { type: 'application/json' });

					// Create download link
					const url = URL.createObjectURL(dataBlob);
					const link = document.createElement('a');
					link.href = url;
					link.download = `financial-plan-${new Date().toISOString().split('T')[0]}.json`;
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					URL.revokeObjectURL(url);
				},
				loadParameters(event) {
					const file = event.target.files[0];
					if (!file) return;

					const reader = new FileReader();
					reader.onload = (e) => {
						try {
							const loadedParams = JSON.parse(e.target.result);
							// Validate that the loaded data has the expected structure
							if (loadedParams && typeof loadedParams === 'object') {
								this.params = loadedParams;
								// Reset file input
								this.$refs.fileInput.value = '';
							} else {
								alert('Invalid file format');
							}
						} catch (error) {
							alert('Error loading file: ' + error.message);
						}
					};
					reader.readAsText(file);
				},
				addTaxRate() {
					// Find the last year and add a new tax rate for the next year
					const lastYear = this.params.taxRates.length > 0
						? this.params.taxRates[this.params.taxRates.length - 1].year
						: 0;
					this.params.taxRates.push({ year: lastYear + 1, rate: 30 });
				},
				removeTaxRate(index) {
					this.params.taxRates.splice(index, 1);
				},
				addAdditionalExpense() {
					const lastYear = this.params.additionalExpenses.length > 0
						? this.params.additionalExpenses[this.params.additionalExpenses.length - 1].year
						: 0;
					this.params.additionalExpenses.push({ year: lastYear + 1, amount: 0, description: '' });
				},
				removeAdditionalExpense(index) {
					this.params.additionalExpenses.splice(index, 1);
				},
				addAsset() {
					this.params.assets.push({ name: 'New Asset', amount: 0, rate: 0, liquid: true });
				},
				removeAsset(index) {
					this.params.assets.splice(index, 1);
				},
				addMilestone() {
					this.params.milestones.push(0);
				},
				removeMilestone(index) {
					this.params.milestones.splice(index, 1);
				},
				getTaxRateForYear(year) {
					// Sort and find the most recent tax rate at or before this year
					const sorted = [...this.params.taxRates].sort((a, b) => a.year - b.year);
					const applicable = sorted.filter(tr => tr.year <= year);
					if (applicable.length > 0) {
						return applicable[applicable.length - 1].rate / 100;
					}
					return sorted.length > 0 ? sorted[0].rate / 100 : 0.3;
				},
				getAdditionalExpenseForYear(year) {
					// Sort and find the most recent additional expense at or before this year
					const sorted = [...this.params.additionalExpenses].sort((a, b) => a.year - b.year);
					const applicable = sorted.filter(e => e.year <= year);
					if (applicable.length > 0) {
						return applicable[applicable.length - 1];
					}
					return { amount: 0, description: '' };
				},
				formatNumber(num) {
					return new Intl.NumberFormat('en-US', {
						minimumFractionDigits: 0,
						maximumFractionDigits: 0
					}).format(num);
				},
				formatCurrency(num) {
					return this.params.currency + this.formatNumber(num);
				},
				formatInputNumber(num) {
					if (num === 0 || num === '') return '';
					return new Intl.NumberFormat('en-US').format(num);
				},
				parseInputNumber(value) {
					// Remove all non-digit characters except decimal point
					const cleaned = value.replace(/[^\d.]/g, '');
					const parsed = parseFloat(cleaned);
					return isNaN(parsed) ? 0 : parsed;
				},
				getEstimatedIncomeForTaxRate(taxRate) {
					// Calculate gross income at the year this tax rate starts
					const grossIncome = this.params.annualGrossIncome * Math.pow(1 + this.params.incomeGrowthRate / 100, taxRate.year);
					// Apply tax to get net income
					const netIncome = grossIncome * (1 - taxRate.rate / 100);
					return netIncome;
				},
				_projectBase(options = {}) {
					// Base projection function that both calculateProjection and calculateProjectionWithZeroIncome use
					const {
						zeroIncomeFromYear = null,
						trackMilestones = false,
						trackGainsLosses = false
					} = options;

					const results = [];
					const p = this.params;

					// Initialize
					let currentGrossIncome = p.annualGrossIncome;
					let currentExpenses = p.annualExpenses;
					const assets = {};
					p.assets.forEach(a => assets[a.name] = a.amount);

					// Track milestones if requested
					const milestonesReached = trackMilestones ? {} : null;
					if (trackMilestones) {
						p.milestones.forEach(m => milestonesReached[m] = null);
					}

					let previousNetWorth = null;

					for (let year = 0; year <= p.years; year++) {
						// Set income to zero after zeroIncomeFromYear if specified
						if (zeroIncomeFromYear !== null && year >= zeroIncomeFromYear) {
							currentGrossIncome = 0;
						}

						const taxRate = this.getTaxRateForYear(year);
						const additionalExpense = this.getAdditionalExpenseForYear(year);
						const totalExpenses = currentExpenses + additionalExpense.amount;
						const currentNetIncome = currentGrossIncome * (1 - taxRate);
						const totalNetWorth = Object.values(assets).reduce((sum, val) => sum + val, 0);
						const annualSavings = year > 0 ? currentNetIncome - totalExpenses : 0;

						// Calculate net worth change
						const netWorthChange = previousNetWorth !== null ? totalNetWorth - previousNetWorth : 0;

						// Check milestones if tracking
						if (trackMilestones) {
							for (const milestone of p.milestones) {
								if (milestonesReached[milestone] === null && totalNetWorth >= milestone) {
									milestonesReached[milestone] = year;
								}
							}
						}

						// Build result object
						const result = { year, totalNetWorth };

						if (trackGainsLosses) {
							// Get unrealized milestones
							const unrealized = p.milestones
								.filter(m => milestonesReached[m] === null)
								.map(m => '€' + (m / 1000000).toFixed(1) + 'M')
								.join(', ');

							// Initialize gain/loss tracking for this year
							const assetAppreciation = {};
							const assetContributions = {};
							const assetLosses = {};
							p.assets.forEach(a => {
								assetAppreciation[a.name] = 0;
								assetContributions[a.name] = 0;
								assetLosses[a.name] = 0;
							});

							result.grossIncome = currentGrossIncome;
							result.netIncome = currentNetIncome;
							result.baseExpenses = currentExpenses;
							result.additionalExpenses = additionalExpense.amount;
							result.expenses = totalExpenses;
							result.savings = annualSavings;
							result.assets = { ...assets };
							result.assetAppreciation = { ...assetAppreciation };
							result.assetContributions = { ...assetContributions };
							result.assetLosses = { ...assetLosses };
							result.netWorthChange = netWorthChange;
							result.unrealizedMilestones = unrealized || 'All reached!';
						}

						results.push(result);
						previousNetWorth = totalNetWorth;

						// Project to next year
						if (year < p.years) {
							// Increase income due to growth rate (only if not yet at zeroIncomeFromYear)
							if (zeroIncomeFromYear === null || year < zeroIncomeFromYear - 1) {
								currentGrossIncome *= 1 + (p.incomeGrowthRate / 100);
							}

							currentExpenses *= 1 + (p.inflationRate / 100);

							// Track gains/losses for this year if requested
							const assetGains = {};
							const assetContributions = {};
							const assetLosses = {};
							if (trackGainsLosses) {
								p.assets.forEach(a => {
									assetGains[a.name] = 0;
									assetContributions[a.name] = 0;
									assetLosses[a.name] = 0;
								});
							}

							// Handle savings/liquidation
							if (annualSavings > 0) {
								const liquidAssets = p.assets.filter(a => a.liquid);
								const totalLiquid = liquidAssets.reduce((sum, a) => sum + assets[a.name], 0);

								if (totalLiquid > 0) {
									liquidAssets.forEach(asset => {
										const proportion = assets[asset.name] / totalLiquid;
										const contribution = annualSavings * proportion;
										assets[asset.name] += contribution;
										if (trackGainsLosses) {
											assetContributions[asset.name] += contribution;
										}
									});
								}
							} else if (annualSavings < 0) {
								const liquidAssets = p.assets.filter(a => a.liquid);
								const totalLiquid = liquidAssets.reduce((sum, a) => sum + assets[a.name], 0);

								if (totalLiquid > 0) {
									const amountToLiquidate = Math.abs(annualSavings);
									liquidAssets.forEach(asset => {
										const proportion = assets[asset.name] / totalLiquid;
										const liquidation = amountToLiquidate * proportion;
										assets[asset.name] -= liquidation;
										if (trackGainsLosses) {
											assetLosses[asset.name] += liquidation;
										}
									});
								}
							}

							// Apply appreciation rates
							p.assets.forEach(asset => {
								const appreciation = assets[asset.name] * (asset.rate / 100);
								assets[asset.name] *= 1 + (asset.rate / 100);
								if (trackGainsLosses) {
									assetGains[asset.name] += appreciation;
								}
							});

							// Update the current year's data with the gains/losses
							if (trackGainsLosses) {
								results[results.length - 1].assetAppreciation = { ...assetGains };
								results[results.length - 1].assetContributions = { ...assetContributions };
								results[results.length - 1].assetLosses = { ...assetLosses };
							}
						}
					}

					return results;
				},
				calculateProjectionWithZeroIncome(startYear) {
					return this._projectBase({
						zeroIncomeFromYear: startYear,
						trackMilestones: false,
						trackGainsLosses: false
					});
				},
				calculateProjection() {
					return this._projectBase({
						zeroIncomeFromYear: null,
						trackMilestones: true,
						trackGainsLosses: true
					});
				},
				updateChart() {
					if (!this.$refs.chart) return;
					if (!this.projection || this.projection.length === 0) return;

					const ctx = this.$refs.chart.getContext('2d');

					// Destroy existing chart
					if (this.chartInstance) {
						this.chartInstance.destroy();
					}

						const years = this.projection.map(p => p.year);

						// Create datasets for each asset
						const datasets = this.params.assets.map((asset, index) => {
							const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
							return {
								label: asset.name,
								data: this.projection.map(p => p.assets[asset.name] || 0),
								borderColor: colors[index % colors.length],
								backgroundColor: colors[index % colors.length] + '20',
								tension: 0.4,
								fill: false
							};
						});

						// Add total net worth dataset
						datasets.push({
							label: 'Total Net Worth',
							data: this.projection.map(p => p.totalNetWorth),
							borderColor: '#2c3e50',
							backgroundColor: '#2c3e5020',
							borderWidth: 3,
							tension: 0.4,
							fill: false
						});

						// Get theme colors
						const isDark = document.body.classList.contains('dark-theme');
						const textColor = isDark ? '#e0e0e0' : '#666';
						const gridColor = isDark ? '#404040' : '#e0e0e0';

						// Create milestone annotations only if annotation plugin is available
						const chartOptions = {
							responsive: true,
							maintainAspectRatio: false,
							animation: false,
							interaction: {
								mode: 'index',
								intersect: false,
							},
							plugins: {
								legend: {
									position: 'top',
									labels: {
										color: textColor
									}
								},
								title: {
									display: true,
									text: 'Net Worth & Asset Projection Over Time (Scroll to zoom, drag to pan)',
									color: textColor
								},
								zoom: {
									zoom: {
										wheel: {
											enabled: true,
										},
										pinch: {
											enabled: true
										},
										mode: 'xy',
									},
									pan: {
										enabled: true,
										mode: 'xy',
									},
									limits: {
										x: {min: 'original', max: 'original'},
										y: {min: 'original', max: 'original'}
									}
								}
							},
							scales: {
								y: {
									beginAtZero: true,
									ticks: {
										color: textColor,
										callback: function(value) {
											if (value === 0) return '€0';
											return '€' + (value / 1000000).toFixed(1) + 'M';
										}
									},
									grid: {
										color: gridColor
									}
								},
								x: {
									ticks: {
										color: textColor
									},
									grid: {
										color: gridColor
									},
									title: {
										display: true,
										text: 'Year',
										color: textColor
									}
								}
							}
						};

						// Add annotations for milestones
						if (this.params.milestones && Array.isArray(this.params.milestones)) {
							const annotations = {};
							this.params.milestones.forEach((milestone, index) => {
								if (milestone && !isNaN(milestone)) {
									annotations['milestone' + index] = {
										type: 'line',
										yMin: milestone,
										yMax: milestone,
										borderColor: '#e67e22',
										borderWidth: 2,
										borderDash: [5, 5],
										label: {
											display: true,
											content: '€' + (milestone / 1000000).toFixed(1) + 'M',
											position: 'end',
											backgroundColor: '#e67e22'
										}
									};
								}
							});

							if (Object.keys(annotations).length > 0) {
								chartOptions.plugins.annotation = { annotations: annotations };
							}
						}

					this.chartInstance = new Chart(ctx, {
						type: 'line',
						data: {
							labels: years,
							datasets: datasets
						},
						options: chartOptions
					});
				}
			},
			mounted() {
				// Apply dark theme on load
				document.body.classList.toggle('dark-theme', this.darkTheme);

				this.$nextTick(() => {
					this.updateChart();
				});

				// Setup tooltip handling
				const tooltip = document.getElementById('tooltip');

				document.addEventListener('mouseover', (e) => {
					if (e.target.classList.contains('tooltip-icon')) {
						const tooltipText = e.target.getAttribute('data-tooltip');
						const rect = e.target.getBoundingClientRect();

						tooltip.textContent = tooltipText;
						tooltip.style.display = 'block';
						tooltip.style.left = (rect.right + 10) + 'px';
						tooltip.style.top = (rect.top + rect.height / 2) + 'px';
						tooltip.style.transform = 'translateY(-50%)';
					}
				});

				document.addEventListener('mouseout', (e) => {
					if (e.target.classList.contains('tooltip-icon')) {
						tooltip.style.display = 'none';
					}
				});
			}
		}).mount('#app');
	</script>
</body>
</html>
